(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{716:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"healthcheck-健康检查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#healthcheck-健康检查"}},[t._v("#")]),t._v(" HEALTHCHECK 健康检查")]),t._v(" "),s("p",[t._v("格式：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("HEALTHCHECK [选项] CMD <命令>")]),t._v("：设置检查容器健康状况的命令")]),t._v(" "),s("li",[s("code",[t._v("HEALTHCHECK NONE")]),t._v("：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令")])]),t._v(" "),s("p",[s("code",[t._v("HEALTHCHECK")]),t._v(" 指令是告诉 Docker 应该如何进行判断容器的状态是否正常，这是 Docker 1.12 引入的新指令。")]),t._v(" "),s("p",[t._v("在没有 "),s("code",[t._v("HEALTHCHECK")]),t._v(" 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。")]),t._v(" "),s("p",[t._v("而自 1.12 之后，Docker 提供了 "),s("code",[t._v("HEALTHCHECK")]),t._v(" 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。")]),t._v(" "),s("p",[t._v("当在一个镜像指定了 "),s("code",[t._v("HEALTHCHECK")]),t._v(" 指令后，用其启动容器，初始状态会为 "),s("code",[t._v("starting")]),t._v("，在 "),s("code",[t._v("HEALTHCHECK")]),t._v(" 指令检查成功后变为 "),s("code",[t._v("healthy")]),t._v("，如果连续一定次数失败，则会变为 "),s("code",[t._v("unhealthy")]),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("HEALTHCHECK")]),t._v(" 支持下列选项：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("--interval=<间隔>")]),t._v("：两次健康检查的间隔，默认为 30 秒；")]),t._v(" "),s("li",[s("code",[t._v("--timeout=<时长>")]),t._v("：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；")]),t._v(" "),s("li",[s("code",[t._v("--retries=<次数>")]),t._v("：当连续失败指定次数后，则将容器状态视为 "),s("code",[t._v("unhealthy")]),t._v("，默认 3 次。")])]),t._v(" "),s("p",[t._v("和 "),s("code",[t._v("CMD")]),t._v(", "),s("code",[t._v("ENTRYPOINT")]),t._v(" 一样，"),s("code",[t._v("HEALTHCHECK")]),t._v(" 只可以出现一次，如果写了多个，只有最后一个生效。")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("HEALTHCHECK [选项] CMD")]),t._v(" 后面的命令，格式和 "),s("code",[t._v("ENTRYPOINT")]),t._v(" 一样，分为 "),s("code",[t._v("shell")]),t._v(" 格式，和 "),s("code",[t._v("exec")]),t._v(" 格式。命令的返回值决定了该次健康检查的成功与否："),s("code",[t._v("0")]),t._v("：成功；"),s("code",[t._v("1")]),t._v("：失败；"),s("code",[t._v("2")]),t._v("：保留，不要使用这个值。")]),t._v(" "),s("p",[t._v("假设我们有个镜像是个最简单的 Web 服务，我们希望增加健康检查来判断其 Web 服务是否在正常工作，我们可以用 "),s("code",[t._v("curl")]),t._v(" 来帮助判断，其 "),s("code",[t._v("Dockerfile")]),t._v(" 的 "),s("code",[t._v("HEALTHCHECK")]),t._v(" 可以这么写：")]),t._v(" "),s("div",{staticClass:"language-docker line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-docker"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" nginx")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("HEALTHCHECK")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("--interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("5s")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("--timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("3s")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" curl -fs http://localhost/ || exit 1")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("这里我们设置了每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 "),s("code",[t._v("curl -fs http://localhost/ || exit 1")]),t._v(" 作为健康检查命令。")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("docker build")]),t._v(" 来构建这个镜像：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" myweb:v1 "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("构建好了后，我们启动一个容器：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" web "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 myweb:v1\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("当运行该镜像后，可以通过 "),s("code",[t._v("docker container ls")]),t._v(" 看到最初的状态为 "),s("code",[t._v("(health: starting)")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" container "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v("\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx -g \'daemon off"')]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" seconds ago       Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" seconds "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("health: starting"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp     web\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("在等待几秒钟后，再次 "),s("code",[t._v("docker container ls")]),t._v("，就会看到健康状态变化为了 "),s("code",[t._v("(healthy)")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" container "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v("\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx -g \'daemon off"')]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" seconds ago      Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" seconds "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp     web\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("如果健康检查连续失败超过了重试次数，状态就会变为 "),s("code",[t._v("(unhealthy)")]),t._v("。")]),t._v(" "),s("p",[t._v("为了帮助排障，健康检查命令的输出（包括 "),s("code",[t._v("stdout")]),t._v(" 以及 "),s("code",[t._v("stderr")]),t._v("）都会被存储于健康状态里，可以用 "),s("code",[t._v("docker inspect")]),t._v(" 来查看。")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" inspect "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--format")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{{json .State.Health}}'")]),t._v(" web "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" python "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" json.tool\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FailingStreak"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"End"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2016-11-25T14:35:37.940957051Z"')]),t._v(",\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ExitCode"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(",\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Output"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<!DOCTYPE html>'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<html>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<head>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<title>Welcome to nginx!</title>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<style>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("    body {"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("        width: 35em;"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("        margin: 0 auto;"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("        font-family: Tahoma, Verdana, Arial, sans-serif;"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("    }"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</style>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</head>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<body>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<h1>Welcome to nginx!</h1>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<p>If you see this page, the nginx web server is successfully installed and"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("working. Further configuration is required.</p>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<p>For online documentation and support please refer to"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<a href="),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("http://nginx.org/"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(">nginx.org</a>.<br/>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("Commercial support is available at"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<a href="),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("http://nginx.com/"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(">nginx.com</a>.</p>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<p><em>Thank you for using nginx.</em></p>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</body>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</html>"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(",\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Start"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2016-11-25T14:35:37.780192565Z"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Status"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"healthy"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);