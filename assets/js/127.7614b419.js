(window.webpackJsonp=window.webpackJsonp||[]).push([[127],{806:function(t,s,n){"use strict";n.r(s);var e=n(11),a=Object(e.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"healthcheck-健康检查"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#healthcheck-健康检查"}},[t._v("#")]),t._v(" HEALTHCHECK 健康检查")]),t._v(" "),n("p",[t._v("格式：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("HEALTHCHECK [选项] CMD <命令>")]),t._v("：设置检查容器健康状况的命令")]),t._v(" "),n("li",[n("code",[t._v("HEALTHCHECK NONE")]),t._v("：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令")])]),t._v(" "),n("p",[n("code",[t._v("HEALTHCHECK")]),t._v(" 指令是告诉 Docker 应该如何进行判断容器的状态是否正常，这是 Docker 1.12 引入的新指令。")]),t._v(" "),n("p",[t._v("在没有 "),n("code",[t._v("HEALTHCHECK")]),t._v(" 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。")]),t._v(" "),n("p",[t._v("而自 1.12 之后，Docker 提供了 "),n("code",[t._v("HEALTHCHECK")]),t._v(" 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。")]),t._v(" "),n("p",[t._v("当在一个镜像指定了 "),n("code",[t._v("HEALTHCHECK")]),t._v(" 指令后，用其启动容器，初始状态会为 "),n("code",[t._v("starting")]),t._v("，在 "),n("code",[t._v("HEALTHCHECK")]),t._v(" 指令检查成功后变为 "),n("code",[t._v("healthy")]),t._v("，如果连续一定次数失败，则会变为 "),n("code",[t._v("unhealthy")]),t._v("。")]),t._v(" "),n("p",[n("code",[t._v("HEALTHCHECK")]),t._v(" 支持下列选项：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("--interval=<间隔>")]),t._v("：两次健康检查的间隔，默认为 30 秒；")]),t._v(" "),n("li",[n("code",[t._v("--timeout=<时长>")]),t._v("：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；")]),t._v(" "),n("li",[n("code",[t._v("--retries=<次数>")]),t._v("：当连续失败指定次数后，则将容器状态视为 "),n("code",[t._v("unhealthy")]),t._v("，默认 3 次。")])]),t._v(" "),n("p",[t._v("和 "),n("code",[t._v("CMD")]),t._v(", "),n("code",[t._v("ENTRYPOINT")]),t._v(" 一样，"),n("code",[t._v("HEALTHCHECK")]),t._v(" 只可以出现一次，如果写了多个，只有最后一个生效。")]),t._v(" "),n("p",[t._v("在 "),n("code",[t._v("HEALTHCHECK [选项] CMD")]),t._v(" 后面的命令，格式和 "),n("code",[t._v("ENTRYPOINT")]),t._v(" 一样，分为 "),n("code",[t._v("shell")]),t._v(" 格式，和 "),n("code",[t._v("exec")]),t._v(" 格式。命令的返回值决定了该次健康检查的成功与否："),n("code",[t._v("0")]),t._v("：成功；"),n("code",[t._v("1")]),t._v("：失败；"),n("code",[t._v("2")]),t._v("：保留，不要使用这个值。")]),t._v(" "),n("p",[t._v("假设我们有个镜像是个最简单的 Web 服务，我们希望增加健康检查来判断其 Web 服务是否在正常工作，我们可以用 "),n("code",[t._v("curl")]),t._v(" 来帮助判断，其 "),n("code",[t._v("Dockerfile")]),t._v(" 的 "),n("code",[t._v("HEALTHCHECK")]),t._v(" 可以这么写：")]),t._v(" "),n("div",{staticClass:"language-docker line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-docker"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" nginx\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" apt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get update && apt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("y curl && rm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf /var/lib/apt/lists/*\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("HEALTHCHECK")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("interval=5s "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("timeout=3s \\\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" curl "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fs http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//localhost/ "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" exit 1\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("p",[t._v("这里我们设置了每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 "),n("code",[t._v("curl -fs http://localhost/ || exit 1")]),t._v(" 作为健康检查命令。")]),t._v(" "),n("p",[t._v("使用 "),n("code",[t._v("docker build")]),t._v(" 来构建这个镜像：")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("docker build -t myweb:v1 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("构建好了后，我们启动一个容器：")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("docker run -d --name web -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 myweb:v1\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("当运行该镜像后，可以通过 "),n("code",[t._v("docker container ls")]),t._v(" 看到最初的状态为 "),n("code",[t._v("(health: starting)")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("docker container "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v("\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx -g \'daemon off"')]),t._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" seconds ago       Up "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" seconds "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("health: starting"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp, "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp     web\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("在等待几秒钟后，再次 "),n("code",[t._v("docker container ls")]),t._v("，就会看到健康状态变化为了 "),n("code",[t._v("(healthy)")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ docker container "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v("\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx -g \'daemon off"')]),t._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" seconds ago      Up "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" seconds "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp, "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp     web\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("如果健康检查连续失败超过了重试次数，状态就会变为 "),n("code",[t._v("(unhealthy)")]),t._v("。")]),t._v(" "),n("p",[t._v("为了帮助排障，健康检查命令的输出（包括 "),n("code",[t._v("stdout")]),t._v(" 以及 "),n("code",[t._v("stderr")]),t._v("）都会被存储于健康状态里，可以用 "),n("code",[t._v("docker inspect")]),t._v(" 来查看。")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ docker inspect --format "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{{json .State.Health}}'")]),t._v(" web "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" python -m json.tool\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FailingStreak"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"End"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2016-11-25T14:35:37.940957051Z"')]),t._v(",\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ExitCode"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(",\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Output"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<!DOCTYPE html>'),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<html>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<head>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<title>Welcome to nginx!</title>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<style>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("    body {"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("        width: 35em;"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("        margin: 0 auto;"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("        font-family: Tahoma, Verdana, Arial, sans-serif;"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("    }"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</style>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</head>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<body>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<h1>Welcome to nginx!</h1>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<p>If you see this page, the nginx web server is successfully installed and"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("working. Further configuration is required.</p>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<p>For online documentation and support please refer to"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<a href="),n("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("http://nginx.org/"),n("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(">nginx.org</a>.<br/>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("Commercial support is available at"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<a href="),n("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("http://nginx.com/"),n("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(">nginx.com</a>.</p>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("<p><em>Thank you for using nginx.</em></p>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</body>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("</html>"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(",\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Start"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2016-11-25T14:35:37.780192565Z"')]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Status"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"healthy"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br")])])])}),[],!1,null,null,null);s.default=a.exports}}]);